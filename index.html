<html>
<head>
    <title>Win Tracker Sync Title</title>
	<style>
		body {
			font-size: 2rem;
			font-family: sans-serif;
			margin-bottom: 4rem;
		}
		input {
			height: 2rem;
			vertical-align: middle;
			font-size: 1.5rem;
		}
		#gamepadStatus {
			margin-bottom: 5rem;
		}
		#gamepadStatus p:nth-child(1) {
			color: red;
		}
		#gamepadStatus p:nth-child(2) {
			color: green;
		}
		#gamepadStatus small {
			color: black;
		}
		#gamepadStatus[data-connected=true] p:nth-child(1) {
			display: none;
		}
		#gamepadStatus:not([data-connected=true]) p:nth-child(2) {
			display: none;
		}
		#statInputs input {
		    width: 80px;
		}
		#statInputs {
			margin-bottom: 5rem;
		}
		.title-label {
			margin-bottom: .5rem;
		}
		#titleInput {
			display: block;
			padding: 1.2rem .5rem;
			width: 1000px;
		}
		#accountStatus p {
			margin: .5rem 0 0 0;
			font-size: 1.5rem;
		}
		#accountStatus p:nth-child(2) {
			color: green;
		}
		#accountStatus[data-linked=true] p:nth-child(1) {
			display: none;
		}
		#accountStatus:not([data-linked=true]) p:nth-child(2) {
			display: none;
		}
		#disconnect {
			vertical-align: 25%;
		}
		.sync-label {
			display: flex;
			align-items: center;
			font-size: 1.2rem;
		}
		#accountStatus:not([data-linked=true]) + .sync-label {
			opacity: .5;
		}
	</style>
</head>
<body>
	<div id="gamepadStatus">
		<p>Gamepad not connected.</p>
		<p>Gamepad connected. <small>Add win: Left Stick, Reset win streak: Back</small></p>
	</div>

	<div id="statInputs"></div>
	
	<p class="title-label">Stream title <small id="titleHelper"></small></p>
	<input type="text" id="titleInput" maxlength="140">
	<div id="accountStatus">
		<p><a href="#" id="connectAccountLink">Connect your Twitch Account</a> to synchronise your stream title.</p>
		<p>Connected to <span id="username"></span>. <button id="disconnect">Disconnect</button></p>
	</div>
	<label class="sync-label"><input disabled type="checkbox" id="sync">synchronise</label>
	
	<script>
	
		const onAddWin = () => {
			const statKeysToIncrement = ['totalWins', 'todaysWins', 'winStreak']
			
			statKeysToIncrement.forEach(key => {
				const el = stats[key]
			
				el.value++
				el.dispatchEvent(changeEvt)
			})
		}
		
		const onResetWinStreak = () => {
			const el = stats.winStreak, changed = el.value > 0
		
			el.value = 0
			if (changed) el.dispatchEvent(changeEvt)
		}
		
		const onWinStreakChange = () => {
			const winStreak = Number(stats.winStreak.value)
			
			if (winStreak > Number(stats.bestWinStreak.value)) stats.bestWinStreak.value = winStreak
		}
	
		const onTitleChange = () => {
			let title = titleInput.value
		
			statKeysInTitle = []
		
			statKeys.forEach(k => { if (title.includes(`[[${k}]]`)) statKeysInTitle.push(k) })
			
			updateStreamTitle()
		}
		
		const onDisconnect = () => {
			account.linked = false
		
			sync.setAttribute('disabled', '')
			sync.checked = false
		
			accountStatus.dataset.linked = false
			
			clearInterval(account.validationInterval)
			
			const revokeTokenURL = new URL('https://id.twitch.tv/oauth2/revoke')
			
			revokeTokenURL.searchParams.append('client_id', clientId)
			revokeTokenURL.searchParams.append('token', account.token)
			
			fetch(revokeTokenURL.toString(), {method: 'POST'})
		}
		
		const init = () => {
			const labels = {
				totalWins: 'Total wins: ',
				todaysWins: 'Today\'s wins: ',
				winStreak: 'Current win streak: ',
				bestWinStreak: 'Best win streak: ',
			}
		
			statKeys.forEach(k => {
				const p = document.createElement('p')
				const input = document.createElement('input')
				
				statInputs.appendChild(p).textContent = labels[k]
				p.appendChild(input).type = 'number'
				
				const onChange = () => {
					if (!input.value) input.value = 0
					if (statKeysInTitle.includes(k)) updateStreamTitle()
				}
				
				input.addEventListener('change', onChange)
				
				stats[k] = input
			})
		
			titleHelper.textContent = `use ${statKeys.map(k => `[[${k}]]`).join(', ')}`
			
			const storedInputsJSON = localStorage.getItem(storageKey)
			
			if (storedInputsJSON) {
				const storedInputs = JSON.parse(storedInputsJSON)
				
				Object.entries(storedInputs.stats).forEach(stat => { stats[stat[0]].value = stat[1] })
				
				titleInput.value = storedInputs.title
			}
			else {
				statKeys.forEach(k => { stats[k].value = 0 })
			
				titleInput.value = statKeys.slice(0, 2).map(k => `${labels[k]}[[${k}]]`).join(', ')
			}
			
			onTitleChange()
			
			setConnectAccountLink()
			
			listenEvents()
			
			listenGamepad()
			
			checkAccount()
		}
		
		const setConnectAccountLink = () => {
			const url = new URL('https://id.twitch.tv/oauth2/authorize')
			
			url.searchParams.append('client_id', clientId)
			url.searchParams.append('redirect_uri', 'https://jeanwll.github.io/wtst/')
			url.searchParams.append('response_type', 'token')
			url.searchParams.append('scope', 'user:edit:broadcast')
		
			connectAccountLink.href = url.toString()
		}
		
		const listenEvents = () => {
			stats.winStreak.addEventListener('change', onWinStreakChange)
			
			titleInput.addEventListener('change', onTitleChange)
			
			sync.addEventListener('change', updateStreamTitle)
			
			disconnect.addEventListener('click', onDisconnect)
			
			addEventListener('unload', () => {
				const storedStats = {}
				
				statKeys.forEach(k => storedStats[k] = stats[k].value)
				
				localStorage.setItem(storageKey, JSON.stringify({stats: storedStats, title: titleInput.value}))
			})
		
		}
		
		const listenGamepad = async () => {
			let gamepad
			
			while (!(gamepad = navigator.getGamepads()[0])) await new Promise(r => setTimeout(r, 1000))
			
			gamepadStatus.dataset.connected = true
			
			const binds = [
				{btnId: 8, action: onResetWinStreak},
				{btnId: 10, action: onAddWin},
			]
			
			do {
				binds.forEach(b => {
					const btn = gamepad.buttons[b.btnId]
					
					if (b.wasPressed && !btn.pressed) {
						b.wasPressed = false
						
						b.action()
						
						return
					}
					
					if (btn.pressed) b.wasPressed = true
				})
				
				await new Promise(r => requestAnimationFrame(r))
				
			} while (gamepad = navigator.getGamepads()[0])
			
			gamepadStatus.dataset.connected = false
			
			listenGamepad()
		}
		
		const checkAccount = async () => {
			const hash = location.hash
			
			if (!hash) return
			
			const hashParams = new URLSearchParams(hash.substr(1))
			
			if (!hashParams.has('access_token')) return
			
			const token = hashParams.get('access_token')
			
			location.hash = ''
			
			const req = new Request(
				'https://api.twitch.tv/helix/users',
				{
					headers: {
						'Client-ID': clientId,
						'Authorization': `Bearer ${token}`
					}
				}
			)
		
			const resp = await fetch(req)
			
			if (!resp.ok) return
		
			const userData = (await resp.json()).data[0]
			
			connectAccount(userData.id, userData.display_name, token)
		}
		
		const connectAccount = (id, name, token) => {
			account.id = id
			account.token = token
			
			username.textContent = name
			
			accountStatus.dataset.linked = true
			
			sync.removeAttribute('disabled')
			
			account.linked = true
			
			account.validationInterval = setInterval(async () => {
				const req = new Request(
					'https://id.twitch.tv/oauth2/validate',
					{headers: {'Authorization': `OAuth ${account.token}`}}
				)
				
				if (!(await fetch(req)).ok) onDisconnect()
			}, 1000 * 60 * 60)
			// required hourly validation of tokens
		}
		
		const updateStreamTitle = () => {
			if (!account.linked || !sync.checked) return
		
			let title = titleInput.value
			
			statKeysInTitle.forEach(k => title = title.replace(`[[${k}]]`, stats[k].value))
			
			title = title.slice(0, 140)
		
			clearTimeout(reqTimeout)
			
			reqTimeout = setTimeout(async () => {
				const req = new Request(
					`https://api.twitch.tv/helix/channels?broadcaster_id=${account.id}`,
					{
						method: 'PATCH',
						headers: {
							'Client-ID': clientId,
							'Authorization': `Bearer ${account.token}`,
							'Content-Type': 'application/json'
						},
						body: JSON.stringify({title})
					}
				)
			
				if (!(await fetch(req)).ok) onDisconnect()
				// user logged out from twitch and trying to update stream title
			}, 3000)
		}
	
		const statKeys = ['totalWins', 'todaysWins', 'winStreak', 'bestWinStreak']
		const storageKey = 'inputs'
		const stats = {}
		const clientId = '7hflhz1a6ifkdztghd6g3abwjz899m'
		const account = {}
		const changeEvt = new Event('change')
		
		let statKeysInTitle = [], reqTimeout
		
		localStorage.removeItem('stats')
		localStorage.removeItem('token')
		
		init()
    </script>
</body>
</html>
